local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local LOCK_KEY = Enum.KeyCode.R

local DASH_ANIM_ID = "rbxassetid://10479335397"
local M1_ANIM_ID = "rbxassetid://656118852"

local lockMode = false
local lastTarget = nil
local justAttacked = false

local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local root = char:WaitForChild("HumanoidRootPart")

local gui = Instance.new("ScreenGui")
gui.Name = "LockIndicator"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui

local box = Instance.new("Frame", gui)
box.Size = UDim2.new(0,10,0,10)
box.Position = UDim2.new(1,-20,1,-20)
box.BackgroundColor3 = Color3.fromRGB(255,0,0)

local function setGUI(on)
	box.BackgroundColor3 = on and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == LOCK_KEY then
		lockMode = not lockMode
		if not lockMode then
			lastTarget = nil
		end
		setGUI(lockMode)
	end
end)

local function attachWatcher(plr)
	if not plr or plr == player then return end
	local function charAdded(c)
		local hum = c:WaitForChild("Humanoid",5)
		if not hum then return end
		hum.HealthChanged:Connect(function(h)
			if lockMode and justAttacked then
				if h > 0 and h < hum.MaxHealth then
					lastTarget = plr
				elseif h <= 0 and lastTarget == plr then
					lastTarget = nil
					lockMode = false
					setGUI(false)
				end
			end
		end)
	end
	plr.CharacterAdded:Connect(charAdded)
	if plr.Character then
		charAdded(plr.Character)
	end
end

for _,p in pairs(Players:GetPlayers()) do
	attachWatcher(p)
end
Players.PlayerAdded:Connect(attachWatcher)

player.CharacterAdded:Connect(function(newChar)
	char = newChar
	humanoid = newChar:WaitForChild("Humanoid")
	root = newChar:WaitForChild("HumanoidRootPart")
end)

humanoid.AnimationPlayed:Connect(function(track)
	if track.Animation then
		local id = tostring(track.Animation.AnimationId)
		if id == DASH_ANIM_ID or id == M1_ANIM_ID then
			justAttacked = true
			task.delay(0.4, function() justAttacked = false end)
		end
	end
end)

RunService.Stepped:Connect(function()
	if not lockMode or not lastTarget then return end
	if not lastTarget.Character or not lastTarget.Character:FindFirstChild("HumanoidRootPart") then
		lastTarget = nil
		return
	end

	local hum = lastTarget.Character:FindFirstChild("Humanoid")
	if hum and hum.Health <= 0 then
		lastTarget = nil
		lockMode = false
		setGUI(false)
		return
	end

	local tr = lastTarget.Character.HumanoidRootPart
	local targetPos = tr.Position
	local myPos = root.Position

	for _,t in ipairs(humanoid:GetPlayingAnimationTracks()) do
		local id = tostring(t.Animation.AnimationId)
		if id == DASH_ANIM_ID then
			local dir = (targetPos - myPos).Unit
			local dashStrength = 0.3
			root.Velocity = dir * (humanoid.WalkSpeed / dashStrength)
		end
	end
end)
