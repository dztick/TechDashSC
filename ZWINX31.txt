local player = game.Players.LocalPlayer
local uis = game:GetService("UserInputService")

local LOCK_KEY = Enum.KeyCode.R
local BLOCK_KEY = Enum.KeyCode.F

local DASH_ANIM_ID = "rbxassetid://10479335397"
local DASH_END_ANIM_ID = "rbxassetid://1451627350"

local lockMode = false
local lastTarget = nil
local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local root = char:WaitForChild("HumanoidRootPart")

local gui = Instance.new("ScreenGui")
gui.Name = "LockIndicator"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui

local box = Instance.new("Frame", gui)
box.Size = UDim2.new(0,10,0,10)
box.Position = UDim2.new(1,-20,1,-20)
box.BackgroundColor3 = Color3.fromRGB(255,0,0)

local function setGUI(on)
    box.BackgroundColor3 = on and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

uis.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == LOCK_KEY then
        lockMode = not lockMode
        if not lockMode then
            lastTarget = nil
        end
        setGUI(lockMode)
    end
end)

local mouse = player:GetMouse()
mouse.Button1Down:Connect(function()
    if mouse.Target and mouse.Target.Parent then
        local model = mouse.Target.Parent
        local plr = game.Players:FindFirstChild(model.Name)
        if plr then
            lastTarget = plr
            if lastTarget.Character then
                local hum = lastTarget.Character:FindFirstChild("Humanoid")
                if hum then
                    hum.Died:Connect(function()
                        if lastTarget == plr then
                            lastTarget = nil
                            setGUI(false)
                            lockMode = false
                        end
                    end)
                end
                lastTarget.CharacterAdded:Connect(function()
                    if lastTarget == plr then
                        lastTarget = nil
                        setGUI(false)
                        lockMode = false
                    end
                end)
            end
        end
    end
end)

humanoid.AnimationPlayed:Connect(function(track)
    if not lockMode then return end
    if track.Animation then
        local animId = track.Animation.AnimationId
        if animId == DASH_ANIM_ID and lastTarget and lastTarget.Character and lastTarget.Character:FindFirstChild("HumanoidRootPart") then
            local targetRoot = lastTarget.Character.HumanoidRootPart
            local targetCFrame = CFrame.new(root.Position, targetRoot.Position)
            root.CFrame = root.CFrame:Lerp(targetCFrame,0.25)
        elseif animId == DASH_END_ANIM_ID then
            local hitbox = Instance.new("Part")
            hitbox.Size = Vector3.new(18,18,18)
            hitbox.Anchored = true
            hitbox.CanCollide = false
            hitbox.Transparency = 1
            hitbox.CFrame = root.CFrame
            hitbox.Parent = workspace
            game.Debris:AddItem(hitbox,0.25)
        end
    end
end)

uis.InputBegan:Connect(function(input,gpe)
    if gpe then return end
    if lockMode and input.KeyCode == BLOCK_KEY then
        if lastTarget and lastTarget.Character and lastTarget.Character:FindFirstChild("HumanoidRootPart") then
            local targetRoot = lastTarget.Character.HumanoidRootPart
            local targetCFrame = CFrame.new(root.Position, targetRoot.Position)
            root.CFrame = root.CFrame:Lerp(targetCFrame,0.25)
        end
    end
end)

player.CharacterAdded:Connect(function(newChar)
    char = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    root = newChar:WaitForChild("HumanoidRootPart")
end)
