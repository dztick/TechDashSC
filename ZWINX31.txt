local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Replication = ReplicatedStorage:FindFirstChild("Replication")

-- State
local currentRoot = nil
local lastHitTarget = nil
local KIBA_MODE = false
local isDashing = false

-- GUI Setup
local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
gui.Name = "KibaModeGUI"
gui.ResetOnSpawn = false

local statusBox = Instance.new("Frame", gui)
statusBox.Size = UDim2.new(0, 20, 0, 20)
statusBox.Position = UDim2.new(1, -30, 1, -30)
statusBox.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

local function updateGUI()
    statusBox.BackgroundColor3 = KIBA_MODE and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

-- Auto update target saat skill mengenai musuh
if Replication then
    Replication.OnClientEvent:Connect(function(data)
        if typeof(data) == "table" and data.Target and data.Target:FindFirstChild("HumanoidRootPart") then
            lastHitTarget = data.Target
        end
    end)
end

-- Dash logic
local function performDash()
    if not lastHitTarget or not currentRoot then return end

    local targetRoot = lastHitTarget:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end

    local targetPos = targetRoot.Position
    local myPos = currentRoot.Position

    isDashing = true

    -- Snap tubuh ke arah musuh sebelum dash
    local dir = (targetPos - myPos).Unit
    currentRoot.CFrame = CFrame.new(myPos, myPos + dir)

    -- Kirim dash ke posisi musuh
    Replication:FireServer({
        Type = "Forward Dash Attack",
        Target = lastHitTarget,
        Position = targetPos
    })

    task.delay(0.5, function()
        isDashing = false
    end)
end

-- Real-time lock arah tubuh saat dash
RunService.RenderStepped:Connect(function()
    if isDashing and KIBA_MODE and currentRoot and lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        local targetRoot = lastHitTarget.HumanoidRootPart
        local dir = (targetRoot.Position - currentRoot.Position).Unit
        currentRoot.CFrame = CFrame.new(currentRoot.Position, currentRoot.Position + dir)
    end
end)

-- Input handler
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end

    if input.KeyCode == Enum.KeyCode.R then
        KIBA_MODE = not KIBA_MODE
        updateGUI()

    elseif input.KeyCode == Enum.KeyCode.Q then
        if KIBA_MODE then
            performDash()
        end
    end
end)

-- Track root part
local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end
if LocalPlayer.Character then onCharacterAdded(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)

updateGUI()
