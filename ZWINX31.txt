local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local DASH_REMOTE_NAME = "Forward Dash Attack"
local HITBOX_MULT = 2
local LOCK_OFFSET = Vector3.new(0,0,0)
local LOCK_ENABLED = false
local currentRoot = nil
local lastHitTarget = nil
local isDashing = false

local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.ResetOnSpawn = false
local StatusBox = Instance.new("Frame", ScreenGui)
StatusBox.Size = UDim2.new(0,20,0,20)
StatusBox.Position = UDim2.new(1,-30,1,-30)
StatusBox.BackgroundColor3 = Color3.fromRGB(255,0,0)

local function updateGUI()
    StatusBox.BackgroundColor3 = LOCK_ENABLED and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

local function updateLastHit(target)
    if target and target:FindFirstChild("HumanoidRootPart") then
        lastHitTarget = target
    end
end

local function applyHitbox(target)
    if target and target:FindFirstChild("HumanoidRootPart") then
        target.HumanoidRootPart.Size = target.HumanoidRootPart.Size * HITBOX_MULT
    end
end

local function getDashDirection()
    if lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        return (lastHitTarget.HumanoidRootPart.Position - currentRoot.Position).Unit
    end
end

local function isTargetAirborne()
    if lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        return lastHitTarget.HumanoidRootPart.Position.Y > currentRoot.Position.Y + 2
    end
    return false
end

local function invokeDash()
    local dashRemote = ReplicatedStorage:FindFirstChild(DASH_REMOTE_NAME)
    if dashRemote and lastHitTarget then
        dashRemote:FireServer(lastHitTarget.HumanoidRootPart.Position)
    end
end

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Target.Parent and Players:FindFirstChild(mouse.Target.Parent.Name) then
            updateLastHit(mouse.Target.Parent)
        end
    elseif input.KeyCode == Enum.KeyCode.R then
        LOCK_ENABLED = not LOCK_ENABLED
        updateGUI()
    elseif input.KeyCode == Enum.KeyCode.Q then
        if LOCK_ENABLED and lastHitTarget and currentRoot and isTargetAirborne() then
            isDashing = true
            applyHitbox(lastHitTarget)
            invokeDash()
            task.delay(0.5,function()
                isDashing = false
            end)
        end
    end
end)

RunService.RenderStepped:Connect(function()
    if isDashing and LOCK_ENABLED and lastHitTarget and currentRoot then
        local targetRoot = lastHitTarget:FindFirstChild("HumanoidRootPart")
        if targetRoot then
            local dir = getDashDirection()
            if dir then
                currentRoot.CFrame = CFrame.new(currentRoot.Position, currentRoot.Position + dir)
            end
        end
    end
end)

local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end
if LocalPlayer.Character then onCharacterAdded(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
