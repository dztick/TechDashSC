local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local LOCK_KEY = Enum.KeyCode.R
local BLOCK_KEY = Enum.KeyCode.F

local DASH_ANIM_ID = "rbxassetid://10479335397"
local M1_ANIM_ID = "rbxassetid://656118852" -- ganti sesuai animasi M1 kalau beda
local DASH_END_ANIM_ID = "rbxassetid://1451627350"

local lockMode = false
local blockLock = false
local lastTarget = nil
local justAttacked = false

local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local root = char:WaitForChild("HumanoidRootPart")

local gui = Instance.new("ScreenGui")
gui.Name = "LockIndicator"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui

local box = Instance.new("Frame", gui)
box.Size = UDim2.new(0,10,0,10)
box.Position = UDim2.new(1,-20,1,-20)
box.BackgroundColor3 = Color3.fromRGB(255,0,0)

local function setGUI(on)
	box.BackgroundColor3 = on and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == LOCK_KEY then
		lockMode = not lockMode
		if not lockMode then
			lastTarget = nil
		end
		setGUI(lockMode)
	elseif input.KeyCode == BLOCK_KEY then
		blockLock = true
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.KeyCode == BLOCK_KEY then
		blockLock = false
	end
end)

local function attachWatcher(plr)
	if not plr or plr == player then return end
	local function charAdded(c)
		local hum = c:WaitForChild("Humanoid",5)
		if not hum then return end
		hum.HealthChanged:Connect(function(h)
			if lockMode and justAttacked then
				if h > 0 and h < hum.MaxHealth then
					lastTarget = plr
				elseif h <= 0 and lastTarget == plr then
					lastTarget = nil
					lockMode = false
					setGUI(false)
				end
			end
		end)
	end
	plr.CharacterAdded:Connect(charAdded)
	if plr.Character then
		charAdded(plr.Character)
	end
end

for _,p in pairs(Players:GetPlayers()) do
	attachWatcher(p)
end
Players.PlayerAdded:Connect(attachWatcher)

player.CharacterAdded:Connect(function(newChar)
	char = newChar
	humanoid = newChar:WaitForChild("Humanoid")
	root = newChar:WaitForChild("HumanoidRootPart")
end)

-- flag justAttacked aktif pas animasi keluar
humanoid.AnimationPlayed:Connect(function(track)
	if track.Animation then
		local id = tostring(track.Animation.AnimationId)
		if id == DASH_ANIM_ID or id == M1_ANIM_ID then
			justAttacked = true
			task.delay(0.5, function() justAttacked = false end)
		end
	end
end)

-- orientasi halus saat dash/block
RunService.Stepped:Connect(function()
	if not root or not humanoid then return end

	local dashPlaying, dashEndPlaying = false, false
	for _,t in ipairs(humanoid:GetPlayingAnimationTracks()) do
		local id = tostring(t.Animation.AnimationId)
		if id == DASH_ANIM_ID then dashPlaying = true end
		if id == DASH_END_ANIM_ID then dashEndPlaying = true end
	end

	if (lockMode or blockLock) and lastTarget and lastTarget.Character and lastTarget.Character:FindFirstChild("HumanoidRootPart") then
		local tr = lastTarget.Character.HumanoidRootPart
		local targetPos = tr.Position
		local myPos = root.Position

		if dashPlaying or blockLock then
			-- hanya rotasi Y agar dash halus, tidak ngagetin
			local lookVector = (Vector3.new(targetPos.X, myPos.Y, targetPos.Z) - myPos).Unit
			root.CFrame = CFrame.new(myPos, myPos + lookVector)
		end
	end

	if dashEndPlaying then
		local hb = Instance.new("Part")
		hb.Size = Vector3.new(18,18,18)
		hb.Anchored = true
		hb.CanCollide = false
		hb.Transparency = 1
		hb.CFrame = root.CFrame
		hb.Parent = workspace
		game.Debris:AddItem(hb, 0.25)
	end
end)
