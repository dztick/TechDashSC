local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local DASH_REMOTE_NAME = "Forward Dash Attack"
local HITBOX_MULT = 3
local LOCK_OFFSET = Vector3.new(0,5,0)

local lastHitTarget = nil
local LOCK_ENABLED = false
local currentRoot = nil
local dashActive = false
local uppercutActive = false
local blockIndicator = false

local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.ResetOnSpawn = false
local StatusBox = Instance.new("Frame", ScreenGui)
StatusBox.Size = UDim2.new(0,20,0,20)
StatusBox.Position = UDim2.new(1,-30,1,-30)
StatusBox.BackgroundColor3 = Color3.fromRGB(255,0,0)

local function updateGUI()
    StatusBox.BackgroundColor3 = (LOCK_ENABLED or blockIndicator or uppercutActive) and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

local function updateLastHit(target)
    if target and target:FindFirstChild("Humanoid") then
        lastHitTarget = target
    end
end

local function applyDashBuff(target)
    if not target or not target:FindFirstChild("HumanoidRootPart") then return end
    local part = target:FindFirstChild("HumanoidRootPart")
    if part then
        part.Size = part.Size * HITBOX_MULT
    end
end

local function getDashDirection(targetPos)
    return (targetPos - currentRoot.Position).Unit
end

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Target.Parent then
            if Players:FindFirstChild(mouse.Target.Parent.Name) then
                updateLastHit(mouse.Target.Parent)
            end
        end
    elseif input.KeyCode == Enum.KeyCode.R then
        LOCK_ENABLED = not LOCK_ENABLED
        updateGUI()
    elseif input.KeyCode == Enum.KeyCode.F then
        blockIndicator = true
        updateGUI()
    elseif input.KeyCode == Enum.KeyCode.Q then
        if lastHitTarget then
            uppercutActive = true
            dashActive = true
            updateGUI()
            task.delay(0.5, function()
                uppercutActive = false
            end)
            task.delay(0.3, function()
                dashActive = false
            end)
        end
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.F then
        blockIndicator = false
        updateGUI()
    end
end)

RunService.RenderStepped:Connect(function()
    if not currentRoot then return end
    if dashActive and lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        local targetRoot = lastHitTarget.HumanoidRootPart
        local targetPos
        if uppercutActive then
            targetPos = targetRoot.Position + Vector3.new(0, 10, 0)
        else
            targetPos = targetRoot.Position + LOCK_OFFSET
        end
        local dir = (targetPos - currentRoot.Position).Unit
        local moveSpeed = 50
        currentRoot.Velocity = dir * moveSpeed
        local lookAt = CFrame.new(currentRoot.Position, targetPos)
        currentRoot.CFrame = currentRoot.CFrame:Lerp(lookAt, 0.2)
    end
end)

for _, obj in ipairs(ReplicatedStorage:GetDescendants()) do
    if obj:IsA("RemoteEvent") and obj.Name == DASH_REMOTE_NAME then
        obj.OnClientEvent:Connect(function()
            if lastHitTarget and currentRoot then
                dashActive = true
                applyDashBuff(lastHitTarget)
                task.delay(0.25, function()
                    dashActive = false
                end)
            end
        end)
    end
end

local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end

if LocalPlayer.Character then
    onCharacterAdded(LocalPlayer.Character)
end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)

updateGUI()
