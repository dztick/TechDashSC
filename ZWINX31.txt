-- DXERR Kiba Tech v5.7 (Frontdash Lock to LastHit, No Auto M1)

if _G.DXERR_KIBA and _G.DXERR_KIBA.cleanup then
    _G.DXERR_KIBA.cleanup()
end
_G.DXERR_KIBA = {}

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local LP = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local KEYS = {
    Toggle = Enum.KeyCode.R,
    Dash   = Enum.KeyCode.Q,
}

local DashSignalName = "Forward Dash Attack"
local dashWindow = 0.6

-- GUI kecil
local gui = Instance.new("ScreenGui")
gui.Name = "DXERR_KibaTech"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = LP:WaitForChild("PlayerGui")

local box = Instance.new("Frame")
box.Size = UDim2.new(0, 10, 0, 10)
box.Position = UDim2.new(1, -20, 1, -20)
box.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
box.Parent = gui

local function setBox(on)
    box.BackgroundColor3 = on and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

local active = false
local function toggle()
    active = not active
    setBox(active)
end

-- Track last hit target
local lastHitTarget = nil

-- Detect M1 hit target (via mouse click)
UIS.InputBegan:Connect(function(input, gp)
    if not gp and input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LP:GetMouse()
        if mouse.Target and mouse.Target.Parent then
            local plr = Players:GetPlayerFromCharacter(mouse.Target.Parent)
            if plr and plr.Character then
                lastHitTarget = plr.Character
            end
        end
    elseif not gp and input.KeyCode == KEYS.Toggle then
        toggle()
    end
end)

-- Dash orientation lock
local lastDashKeyTime = 0
UIS.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == KEYS.Dash then
        lastDashKeyTime = tick()
    end
end)

-- Remote hook
local repConn
do
    local replication = ReplicatedStorage:FindFirstChild("Replication")
    if replication and replication:IsA("RemoteEvent") then
        repConn = replication.OnClientEvent:Connect(function(arg1)
            if not active then return end
            if typeof(arg1) ~= "table" then return end
            if arg1.Name ~= DashSignalName then return end
            if tick() - lastDashKeyTime > dashWindow then return end

            if lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
                local myRoot = LP.Character.HumanoidRootPart
                local targetRoot = lastHitTarget.HumanoidRootPart
                local look = CFrame.new(myRoot.Position, targetRoot.Position)
                LP.Character:PivotTo(look)
            end
        end)
    else
        warn("Replication RemoteEvent tidak ditemukan.")
    end
end

-- Persist after respawn
local function onCharAdded(char)
    char:WaitForChild("HumanoidRootPart")
end
if LP.Character then onCharAdded(LP.Character) end
LP.CharacterAdded:Connect(onCharAdded)

_G.DXERR_KIBA.cleanup = function()
    pcall(function() if repConn then repConn:Disconnect() end end)
    pcall(function() gui:Destroy() end)
    _G.DXERR_KIBA = nil
end

print("âœ… DXERR Kiba Tech v5.7 aktif. Toggle:", KEYS.Toggle.Name)
