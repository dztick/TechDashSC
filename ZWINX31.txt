local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Replication = ReplicatedStorage:WaitForChild("Replication")

-- State
local currentRoot = nil
local lastHitTarget = nil
local COMBO_MODE = false

-- GUI Setup
local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
gui.Name = "ComboModeGUI"
gui.ResetOnSpawn = false

local statusBox = Instance.new("Frame", gui)
statusBox.Size = UDim2.new(0, 20, 0, 20)
statusBox.Position = UDim2.new(1, -30, 1, -30)
statusBox.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

local function updateGUI()
    statusBox.BackgroundColor3 = COMBO_MODE and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

-- Fire Replication remote
local function fireReplication(typeName, position)
    if lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        Replication:FireServer({
            Type = typeName,
            Target = lastHitTarget,
            Position = position
        })
    end
end

-- Combo chaining
local function startCombo()
    if not COMBO_MODE or not lastHitTarget or not currentRoot then return end

    local targetPos = lastHitTarget.HumanoidRootPart.Position
    fireReplication("Uppercut", targetPos)

    task.delay(0.3, function()
        local upwardPos = targetPos + Vector3.new(0, 10, 0)
        currentRoot.CFrame = CFrame.new(currentRoot.Position, upwardPos)
        fireReplication("Forward Dash Attack", upwardPos)
    end)
end

-- Input handler
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end

    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Target.Parent and mouse.Target.Parent:FindFirstChild("HumanoidRootPart") then
            lastHitTarget = mouse.Target.Parent
        end

    elseif input.KeyCode == Enum.KeyCode.R then
        COMBO_MODE = not COMBO_MODE
        updateGUI()
        if COMBO_MODE then
            startCombo()
        end
    end
end)

-- Get root part
local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end
if LocalPlayer.Character then onCharacterAdded(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
