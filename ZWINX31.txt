local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Remote names
local DASH_REMOTE_NAME = "Forward Dash Attack"

-- State variables
local LOCK_ENABLED = false
local currentRoot = nil
local lastHitTarget = nil
local isChaining = false

-- GUI Setup
local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
gui.Name = "LockDashGUI"
gui.ResetOnSpawn = false

local statusBox = Instance.new("Frame", gui)
statusBox.Size = UDim2.new(0, 20, 0, 20)
statusBox.Position = UDim2.new(1, -30, 1, -30)
statusBox.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

local function updateGUI()
    statusBox.BackgroundColor3 = LOCK_ENABLED and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

-- Update target saat klik musuh
local function updateLastHit(target)
    if target and target:FindFirstChild("HumanoidRootPart") and Players:FindFirstChild(target.Name) then
        lastHitTarget = target
    end
end

-- Arah ke target
local function getDirection()
    if lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        return (lastHitTarget.HumanoidRootPart.Position - currentRoot.Position).Unit
    end
end

-- Fire dash remote
local function fireDash()
    local remote = ReplicatedStorage:FindFirstChild(DASH_REMOTE_NAME)
    if remote and lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        local pos = lastHitTarget.HumanoidRootPart.Position
        remote:FireServer({["Target"] = lastHitTarget, ["Position"] = pos})
    end
end

-- Start chaining
local function startChain()
    if not LOCK_ENABLED or not lastHitTarget or not currentRoot then return end
    isChaining = true

    -- Dash
    fireDash()

    -- Arahkan tubuh ke target
    local dir = getDirection()
    if dir then
        currentRoot.CFrame = CFrame.new(currentRoot.Position, currentRoot.Position + dir)
    end

    -- Bisa ditambah skill chaining di sini kalau mau
    task.delay(0.5, function()
        isChaining = false
    end)
end

-- Input handler
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end

    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Target.Parent then
            updateLastHit(mouse.Target.Parent)
        end

    elseif input.KeyCode == Enum.KeyCode.R then
        LOCK_ENABLED = not LOCK_ENABLED
        updateGUI()

    elseif input.KeyCode == Enum.KeyCode.Q then
        startChain()
    end
end)

-- Ambil HumanoidRootPart saat karakter muncul
local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end
if LocalPlayer.Character then onCharacterAdded(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
