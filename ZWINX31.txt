local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local DASH_REMOTE_NAME = "Forward Dash Attack"
local DASH_HITBOX_MULT = 3
local DASH_SPEED = 0.4
local LOCK_OFFSET = Vector3.new(0,-2,0)
local FLOAT_DURATION = 0.2

local lastHitTarget = nil
local MODE_ON = false
local currentRoot = nil
local isDashing = false
local lockDuringDash = false

local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.ResetOnSpawn = false
local StatusBox = Instance.new("Frame", ScreenGui)
StatusBox.Size = UDim2.new(0,20,0,20)
StatusBox.Position = UDim2.new(1,-30,1,-30)
StatusBox.BackgroundColor3 = Color3.fromRGB(255,0,0)

local function updateGUI()
    StatusBox.BackgroundColor3 = lockDuringDash and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

local function updateLastHit(target)
    if target and target:FindFirstChild("Humanoid") then
        lastHitTarget = target
    end
end

local function applyDashBuff(target)
    if not target or not target:FindFirstChild("HumanoidRootPart") then return end
    local part = target:FindFirstChild("HumanoidRootPart")
    part.Size = part.Size * DASH_HITBOX_MULT
end

local function performDash(target)
    if not target or not currentRoot then return end
    local targetRoot = target:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end
    applyDashBuff(target)
    isDashing = true
    lockDuringDash = true
    updateGUI()
    local dashRemote = ReplicatedStorage:FindFirstChild(DASH_REMOTE_NAME)
    if dashRemote then
        local startPos = currentRoot.Position
        local endPos = Vector3.new(targetRoot.Position.X, targetRoot.Position.Y + LOCK_OFFSET.Y, targetRoot.Position.Z)
        local elapsed = 0
        local duration = DASH_SPEED
        RunService:BindToRenderStep("DashStep", Enum.RenderPriority.Camera.Value, function(delta)
            if elapsed < duration then
                elapsed = elapsed + delta
                local alpha = math.clamp(elapsed/duration,0,1)
                local newPos = startPos:Lerp(endPos, alpha)
                currentRoot.CFrame = CFrame.new(newPos)
                -- Float effect untuk musuh agar tetap di tempat sebentar saat dash
                if targetRoot.Position.Y > currentRoot.Position.Y then
                    targetRoot.CFrame = CFrame.new(Vector3.new(targetRoot.Position.X, targetRoot.Position.Y, targetRoot.Position.Z))
                end
            else
                isDashing = false
                lockDuringDash = false
                updateGUI()
                RunService:UnbindFromRenderStep("DashStep")
            end
        end)
        dashRemote:FireServer((endPos - startPos).Unit)
    end
end

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Target.Parent and Players:FindFirstChild(mouse.Target.Parent.Name) then
            updateLastHit(mouse.Target.Parent)
        end
    elseif input.KeyCode == Enum.KeyCode.R then
        MODE_ON = not MODE_ON
        StatusBox.BackgroundColor3 = MODE_ON and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
    elseif input.KeyCode == Enum.KeyCode.Q then
        if MODE_ON and lastHitTarget and not isDashing then
            performDash(lastHitTarget)
        end
    end
end)

local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end

if LocalPlayer.Character then
    onCharacterAdded(LocalPlayer.Character)
end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
