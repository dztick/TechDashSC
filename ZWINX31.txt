local player = game.Players.LocalPlayer
local uis = game:GetService("UserInputService")

local LOCK_KEY = Enum.KeyCode.R
local BLOCK_KEY = Enum.KeyCode.F

local DASH_ANIM_ID = "rbxassetid://10479335397"
local DASH_END_ANIM_ID = "rbxassetid://1451627350"

local lockMode = false
local lastTarget = nil
local char = player.Character or player.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local root = char:WaitForChild("HumanoidRootPart")

local gui = Instance.new("ScreenGui")
gui.Name = "LockIndicator"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui

local box = Instance.new("Frame", gui)
box.Size = UDim2.new(0,10,0,10)
box.Position = UDim2.new(1,-20,1,-20)
box.BackgroundColor3 = Color3.fromRGB(255,0,0)

local function setGUI(on)
    box.BackgroundColor3 = on and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

uis.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == LOCK_KEY then
        lockMode = not lockMode
        if not lockMode then
            lastTarget = nil
        end
        setGUI(lockMode)
    end
end)

local function trackTarget(plr)
    if plr == player then return end
    plr.CharacterAdded:Connect(function(char)
        local hum = char:WaitForChild("Humanoid")
        hum.HealthChanged:Connect(function(hp)
            if hp < hum.MaxHealth and hp > 0 then
                lastTarget = plr
            elseif hp <= 0 and lastTarget == plr then
                lastTarget = nil
                lockMode = false
                setGUI(false)
            end
        end)
    end)
    if plr.Character and plr.Character:FindFirstChild("Humanoid") then
        local hum = plr.Character.Humanoid
        hum.HealthChanged:Connect(function(hp)
            if hp < hum.MaxHealth and hp > 0 then
                lastTarget = plr
            elseif hp <= 0 and lastTarget == plr then
                lastTarget = nil
                lockMode = false
                setGUI(false)
            end
        end)
    end
end

for _,plr in pairs(game.Players:GetPlayers()) do
    trackTarget(plr)
end
game.Players.PlayerAdded:Connect(trackTarget)

humanoid.AnimationPlayed:Connect(function(track)
    if not lockMode or not lastTarget then return end
    if track.Animation then
        local animId = track.Animation.AnimationId
        if animId == DASH_ANIM_ID and lastTarget.Character and lastTarget.Character:FindFirstChild("HumanoidRootPart") then
            local targetRoot = lastTarget.Character.HumanoidRootPart
            root.CFrame = root.CFrame:Lerp(CFrame.new(root.Position, targetRoot.Position),0.25)
        elseif animId == DASH_END_ANIM_ID then
            -- hitbox dash (opsional)
            local hitbox = Instance.new("Part")
            hitbox.Size = Vector3.new(18,18,18)
            hitbox.Anchored = true
            hitbox.CanCollide = false
            hitbox.Transparency = 1
            hitbox.CFrame = root.CFrame
            hitbox.Parent = workspace
            game.Debris:AddItem(hitbox,0.25)
        end
    end
end)

uis.InputBegan:Connect(function(input,gpe)
    if gpe then return end
    if lockMode and input.KeyCode == BLOCK_KEY then
        if lastTarget and lastTarget.Character and lastTarget.Character:FindFirstChild("HumanoidRootPart") then
            local targetRoot = lastTarget.Character.HumanoidRootPart
            root.CFrame = root.CFrame:Lerp(CFrame.new(root.Position, targetRoot.Position),0.25)
        end
    end
end)

player.CharacterAdded:Connect(function(newChar)
    char = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    root = newChar:WaitForChild("HumanoidRootPart")
end)
