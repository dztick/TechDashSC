local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Replication = ReplicatedStorage:WaitForChild("Replication")

-- State
local currentRoot = nil
local lastHitTarget = nil
local KIBA_MODE = false

-- GUI Setup
local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
gui.Name = "KibaModeGUI"
gui.ResetOnSpawn = false

local statusBox = Instance.new("Frame", gui)
statusBox.Size = UDim2.new(0, 20, 0, 20)
statusBox.Position = UDim2.new(1, -30, 1, -30)
statusBox.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

local function updateGUI()
    statusBox.BackgroundColor3 = KIBA_MODE and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

-- Fire Replication remote
local function fireReplication(typeName, position)
    if lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        Replication:FireServer({
            Type = typeName,
            Target = lastHitTarget,
            Position = position
        })
    end
end

-- Dash logic
local function performDash()
    if not lastHitTarget or not currentRoot then return end

    local targetRoot = lastHitTarget:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end

    local targetPos = targetRoot.Position
    local myPos = currentRoot.Position

    local isAbove = targetPos.Y > myPos.Y + 2

    if KIBA_MODE and isAbove then
        -- Kiba-style vertical dash
        local upwardPos = targetPos + Vector3.new(0, 10, 0)
        currentRoot.CFrame = CFrame.new(myPos, upwardPos)
        fireReplication("Forward Dash Attack", upwardPos)
    else
        -- Dash biasa
        currentRoot.CFrame = CFrame.new(myPos, targetPos)
        fireReplication("Forward Dash Attack", targetPos)
    end
end

-- Input handler
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end

    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Target.Parent and mouse.Target.Parent:FindFirstChild("HumanoidRootPart") then
            lastHitTarget = mouse.Target.Parent
        end

    elseif input.KeyCode == Enum.KeyCode.R then
        KIBA_MODE = not KIBA_MODE
        updateGUI()

    elseif input.KeyCode == Enum.KeyCode.Q then
        performDash()
    end
end)

-- Get root part
local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end
if LocalPlayer.Character then onCharacterAdded(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
