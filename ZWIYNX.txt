local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local DASH_REMOTE_NAME = "Forward Dash Attack"
local HITBOX_MULT = 3
local DASH_LERP_SPEED = 0.3
local ANTI_KNOCKBACK_FORCE = 0.5
local CHAIN_RADIUS = 15

local lastHitTarget = nil
local LOCK_ENABLED = true
local currentRoot = nil
local lastRootPos = nil
local lockOffset = Vector3.new(0,5,0)

local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.ResetOnSpawn = false
local StatusBox = Instance.new("Frame", ScreenGui)
StatusBox.Size = UDim2.new(0,20,0,20)
StatusBox.Position = UDim2.new(1,-30,1,-30)
StatusBox.BackgroundColor3 = Color3.fromRGB(0,255,0)

local function updateLastHit(target)
    lastHitTarget = target
end

local function updateGUI()
    StatusBox.BackgroundColor3 = LOCK_ENABLED and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end

local function applyBuff(target)
    if not target or not target:FindFirstChild("HumanoidRootPart") then return end
    local hitbox = target:FindFirstChildWhichIsA("Part") or target:FindFirstChild("HumanoidRootPart")
    if hitbox then
        hitbox.Size = hitbox.Size * HITBOX_MULT
    end
end

local function getDashDirection(targetPos)
    local rootPos = currentRoot.Position
    local dir = (targetPos - rootPos).Unit
    return Vector3.new(dir.X, dir.Y, dir.Z)
end

local function getNearbyTargets()
    local targets = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local distance = (currentRoot.Position - p.Character.HumanoidRootPart.Position).Magnitude
            if distance <= CHAIN_RADIUS then
                table.insert(targets, p.Character)
            end
        end
    end
    return targets
end

for _, obj in ipairs(ReplicatedStorage:GetDescendants()) do
    if obj:IsA("RemoteEvent") and obj.Name == DASH_REMOTE_NAME then
        obj.OnClientEvent:Connect(function()
            if lastHitTarget and currentRoot then
                applyBuff(lastHitTarget)
                local targetRoot = lastHitTarget:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    local dir = getDashDirection(targetRoot.Position + lockOffset)
                    currentRoot.CFrame = CFrame.new(currentRoot.Position, currentRoot.Position + dir)
                end
                for _, chainTarget in ipairs(getNearbyTargets()) do
                    if chainTarget and chainTarget:FindFirstChild("HumanoidRootPart") then
                        applyBuff(chainTarget)
                    end
                end
            end
        end)
    end
end

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mouse = LocalPlayer:GetMouse()
        if mouse.Target and mouse.Target.Parent then
            local targetHumanoid = mouse.Target.Parent:FindFirstChild("Humanoid")
            if targetHumanoid and Players:FindFirstChild(mouse.Target.Parent.Name) then
                updateLastHit(mouse.Target.Parent)
            end
        end
    elseif input.KeyCode == Enum.KeyCode.R then
        LOCK_ENABLED = not LOCK_ENABLED
        updateGUI()
    end
end)

RunService.RenderStepped:Connect(function()
    if not currentRoot then return end

    if lastRootPos then
        local delta = currentRoot.Position - lastRootPos
        if LOCK_ENABLED and delta.Magnitude > 1 then
            currentRoot.CFrame = CFrame.new(lastRootPos:Lerp(currentRoot.Position, ANTI_KNOCKBACK_FORCE))
        end
    end
    lastRootPos = currentRoot.Position

    if LOCK_ENABLED and lastHitTarget and lastHitTarget:FindFirstChild("HumanoidRootPart") then
        local targetRoot = lastHitTarget.HumanoidRootPart
        local dir = getDashDirection(targetRoot.Position + lockOffset)
        local lookY = currentRoot.CFrame.LookVector.Y
        if targetRoot.Position.Y > currentRoot.Position.Y then
            lookY = dir.Y
        end
        local newLook = Vector3.new(dir.X, lookY, dir.Z)
        currentRoot.CFrame = CFrame.new(currentRoot.Position, currentRoot.Position + newLook)
    end
end)

local function onCharacterAdded(char)
    currentRoot = char:WaitForChild("HumanoidRootPart")
end

if LocalPlayer.Character then
    onCharacterAdded(LocalPlayer.Character)
end
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)

updateGUI()
